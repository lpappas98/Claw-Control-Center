# Task Workflow & Agent Integration

## Overview

The Claw Control Center provides a task management system that enables multi-agent coordination. This guide explains the complete lifecycle: task creation, agent assignment, heartbeat polling, and status tracking.

## Task Lifecycle

```
Created → Queued → Development → Review → Done
                      ↓
                    (or) Blocked
```

### Lanes (Task States)

| Lane | Meaning | Who Sets It | Purpose |
|------|---------|-------------|---------|
| `queued` | Ready for agent pickup | PM or task creator | Task waiting for an available agent |
| `development` | Agent is actively working | Agent picks it up | Task is in progress |
| `review` | Work complete, awaiting review | Agent marks for review | QA or PM verifies before merge |
| `done` | Task complete | Reviewer approves | Closed and tracked in history |
| `blocked` | Cannot proceed | Agent or PM | Task stuck; requires intervention |

## Task Schema

When creating or querying tasks, use this structure:

```json
{
  "id": "task-{uuid}-{timestamp}",
  "title": "Human-readable task name",
  "lane": "queued",
  "priority": "P0",
  "owner": "architect",
  "problem": "Why this task exists (context)",
  "scope": "What work needs to be done",
  "acceptanceCriteria": [
    "Must do X",
    "Must verify Y",
    "Must commit Z"
  ],
  "createdAt": "2026-02-14T08:00:41.156Z",
  "updatedAt": "2026-02-14T08:00:41.156Z",
  "statusHistory": [
    {
      "at": "2026-02-14T08:00:41.156Z",
      "to": "queued",
      "note": "created"
    }
  ]
}
```

### Field Explanations

- **id**: Unique task identifier. Format: `task-{uuid}-{timestamp}`. Auto-generated by API.
- **title**: Brief, actionable description (50 chars max recommended).
- **lane**: Current task state (queued, development, review, done, blocked).
- **priority**: Urgency level.
  - `P0`: Critical blocker
  - `P1`: High priority, do today
  - `P2`: Medium priority, this sprint
  - `P3`: Low priority, backlog
- **owner**: Agent ID responsible for this task.
  - `pm`: Project Manager (TARS)
  - `dev-1`: Developer #1 (Forge)
  - `dev-2`: Developer #2 (Patch)
  - `qa`: QA Engineer (Sentinel)
  - `architect`: System Architect (Blueprint)
- **problem**: Context and motivation. Why does this task exist?
- **scope**: Specific work required (what, not why).
- **acceptanceCriteria**: Must-have outcomes. Agent verifies these before marking done.

## Agent IDs (Owner Mapping)

The `owner` field must match an agent's ID configured in OpenClaw:

```
pm          → TARS (Project Manager)
dev-1       → Forge (Developer)
dev-2       → Patch (Developer)
qa          → Sentinel (QA Engineer)
architect   → Blueprint (System Architect)
```

See `docs/AGENT_SETUP.md` for full agent configuration.

## API Reference

### Create Task

**Endpoint:** `POST /api/tasks`

**Request:**
```bash
curl -X POST http://localhost:8787/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Implement login form",
    "lane": "queued",
    "priority": "P1",
    "owner": "dev-1",
    "problem": "Users cannot create accounts",
    "scope": "Build LoginForm component, wire to Firebase Auth, add email/password fields",
    "acceptanceCriteria": [
      "Form renders without errors",
      "Email validation works",
      "Firebase authentication succeeds",
      "Redirect to home on success",
      "Error messages display on failure"
    ]
  }'
```

**Response:**
```json
{
  "id": "task-a1b2c3d4-1234567890",
  "title": "Implement login form",
  "lane": "queued",
  "priority": "P1",
  "owner": "dev-1",
  "createdAt": "2026-02-14T09:18:00Z",
  "statusHistory": [
    {
      "at": "2026-02-14T09:18:00Z",
      "to": "queued",
      "note": "created"
    }
  ]
}
```

### Query Tasks

**Endpoint:** `GET /api/tasks`

**Query Parameters:**
- `lane`: Filter by lane (queued, development, review, done, blocked)
- `owner`: Filter by agent ID (pm, dev-1, dev-2, qa, architect)
- `priority`: Filter by priority (P0, P1, P2, P3)

**Examples:**

Find all tasks assigned to an agent:
```bash
curl -s "http://localhost:8787/api/tasks?lane=queued&owner=dev-1"
```

Find all developer tasks in development:
```bash
curl -s "http://localhost:8787/api/tasks?lane=development&owner=dev-1"
```

Find all high-priority tasks:
```bash
curl -s "http://localhost:8787/api/tasks?priority=P0"
```

### Update Task Status

**Endpoint:** `PUT /api/tasks/{taskId}`

**Request:**
```bash
curl -X PUT http://localhost:8787/api/tasks/task-a1b2c3d4-1234567890 \
  -H "Content-Type: application/json" \
  -d '{
    "lane": "review",
    "note": "Implementation complete, ready for QA verification"
  }'
```

**Response:**
```json
{
  "id": "task-a1b2c3d4-1234567890",
  "lane": "review",
  "updatedAt": "2026-02-14T10:30:00Z",
  "statusHistory": [
    { "at": "2026-02-14T09:18:00Z", "to": "queued", "note": "created" },
    { "at": "2026-02-14T09:20:00Z", "to": "development", "note": "dev-1 started work" },
    { "at": "2026-02-14T10:30:00Z", "to": "review", "note": "Implementation complete, ready for QA verification" }
  ]
}
```

### List All Tasks

**Endpoint:** `GET /api/tasks`

```bash
curl -s "http://localhost:8787/api/tasks"
```

Returns all tasks with full history.

## Agent Workflow

### Step 1: Agent Heartbeat Check

Every agent runs a heartbeat every 30 seconds. The heartbeat:

1. **Queries for new tasks** assigned to the agent:
   ```bash
   curl -s "http://localhost:8787/api/tasks?lane=queued&owner={agentId}"
   ```

2. **Selects highest priority** (P0 > P1 > P2 > P3)

3. **Moves task to development** (updates lane):
   ```bash
   curl -X PUT http://localhost:8787/api/tasks/{taskId} \
     -H "Content-Type: application/json" \
     -d '{"lane":"development","note":"Started by {agentId}"}'
   ```

4. **Executes task** according to acceptance criteria

### Step 2: Agent Completes Work

When done, agent:

1. **Commits code** to feature branch
2. **Moves task to review**:
   ```bash
   curl -X PUT http://localhost:8787/api/tasks/{taskId} \
     -d '{"lane":"review","note":"Ready for review: [summary of work]"}'
   ```
3. **Posts link** to PR or commit

### Step 3: Reviewer (PM/QA) Verifies

Reviewer:

1. **Checks acceptance criteria** (run tests, verify behavior)
2. **Marks done** if all criteria met:
   ```bash
   curl -X PUT http://localhost:8787/api/tasks/{taskId} \
     -d '{"lane":"done","note":"Verified and merged"}'
   ```
3. **Or marks blocked** if issues found:
   ```bash
   curl -X PUT http://localhost:8787/api/tasks/{taskId} \
     -d '{"lane":"blocked","note":"Needs revision: [specific issue]"}'
   ```

## Heartbeat System

### Configuration

Agents poll every **30 seconds** by default. Configure in `config.yaml`:

```yaml
agents:
  - id: dev-1
    heartbeat:
      intervalSeconds: 30
      enabled: true
```

### Heartbeat Behavior

Each heartbeat cycle:

1. **Check HEARTBEAT.md** for standing instructions
2. **Query for queued tasks** specific to agent
3. **Pick highest priority task**
4. **Move to development**
5. **Execute task**
6. **Move to review or done**
7. **If no queued tasks:** Reply `HEARTBEAT_OK`

### Monitoring Heartbeats

View recent agent activity:

```bash
curl -s "http://localhost:8787/api/heartbeats?agent=dev-1&limit=10"
```

View task history:

```bash
curl -s "http://localhost:8787/api/tasks/task-{id}"
```

Check `statusHistory` field for all transitions.

## Example: Complete Workflow

### 1. PM Creates Task

**Time: 09:00 UTC**

```bash
curl -X POST http://localhost:8787/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Fix mobile nav spacing",
    "lane": "queued",
    "priority": "P1",
    "owner": "dev-2",
    "problem": "Mobile menu items overlap on small screens (iPhone SE, Galaxy A12)",
    "scope": "Adjust NavBar component padding/gap for viewports <375px. Test on iOS and Android",
    "acceptanceCriteria": [
      "NavBar renders without overlap on 320px viewport",
      "Tested on iPhone SE simulator",
      "Tested on Galaxy A12 emulator",
      "PR merged to main",
      "No regression on desktop (1440px+)"
    ]
  }'
```

**Response:**
```
task-abc123def456-1676380800
```

### 2. Agent Picks Up Task (30s later)

**Time: 09:00:30 UTC**

Agent dev-2 (Patch) heartbeat queries:
```bash
curl -s "http://localhost:8787/api/tasks?lane=queued&owner=dev-2"
```

Finds the task. Updates to development:
```bash
curl -X PUT http://localhost:8787/api/tasks/task-abc123def456-1676380800 \
  -d '{"lane":"development","note":"Patch starting work"}'
```

### 3. Agent Executes Work

Agent:
- Checks out feature branch
- Modifies `src/components/NavBar.tsx`
- Tests on iOS simulator (320px) ✅
- Tests on Android emulator (320px) ✅
- Commits: `git commit -m "Fix: adjust nav spacing for small screens"`
- Pushes to GitHub

### 4. Agent Marks Ready for Review

```bash
curl -X PUT http://localhost:8787/api/tasks/task-abc123def456-1676380800 \
  -d '{"lane":"review","note":"Responsive fix complete. Tested 320-1440px viewports. PR: github.com/lpappas98/repo/pull/42"}'
```

### 5. Reviewer (QA) Verifies

**Time: 09:30 UTC**

Sentinel (QA) checks:
- Opens PR 42
- Runs test suite ✅
- Tests on actual devices ✅
- Verifies no desktop regression ✅

All criteria met. Marks done:
```bash
curl -X PUT http://localhost:8787/api/tasks/task-abc123def456-1676380800 \
  -d '{"lane":"done","note":"Verified and merged. PR #42 closed."}'
```

**Task complete!** Total time: 30 minutes.

## Troubleshooting

### Agent Not Picking Up Tasks

**Symptom:** Tasks stay in `queued` lane; agents don't move them to `development`.

**Causes:**
1. Agent heartbeat disabled
2. Agent ID in `owner` field doesn't match configured agent ID
3. Heartbeat interval too long
4. Bridge not accessible (http://localhost:8787)

**Fix:**
1. Check `config.yaml`: Verify `agents.heartbeat.enabled: true`
2. Verify agent IDs: `curl http://localhost:8787/api/agents`
3. Check bridge logs: `journalctl -u claw-control-center -f`
4. Test connectivity: `curl http://localhost:8787/api/health`

### Task Stuck in Development

**Symptom:** Agent moved task to `development` but never progressed.

**Causes:**
1. Agent crashed or stopped
2. Task acceptance criteria unclear
3. Agent blocked on external dependency
4. No review process defined

**Fix:**
1. Move task to `blocked` with explanation
2. Assign to different agent
3. Create sub-tasks for blockers
4. Re-assign after dependencies resolved

### Heartbeat Not Running

**Symptom:** Agent heartbeat cron job not firing.

**Fix:**
1. Verify cron service running: `systemctl status crond`
2. Check cron logs: `journalctl -u cron -f`
3. Verify agent is configured in OpenClaw
4. Test agent directly: `openclaw sessions_spawn --agentId=dev-1 --task="test"`

### Task Created But Not Visible

**Symptom:** POST request succeeds but task doesn't appear in GET results.

**Causes:**
1. Filter parameters exclude the task
2. Task ID format invalid
3. JSON parsing issue
4. Storage write failure

**Fix:**
1. Get all tasks: `curl http://localhost:8787/api/tasks` (no filters)
2. Check response for errors
3. Verify JSON syntax in creation request
4. Check bridge logs for storage errors

## Best Practices

### Task Creation

- ✅ **Be specific:** Good: "Implement Google Sign-In button with error handling". Bad: "Fix auth"
- ✅ **One concern per task:** Split multi-part work into subtasks
- ✅ **Clear acceptance criteria:** Make it testable and unambiguous
- ✅ **Assign to right owner:** Match agent expertise to task
- ✅ **Use correct priority:** P0 for blockers, P1 for today, P2 for sprint, P3 for backlog

### Agent Workflow

- ✅ **Move to development immediately:** Lock the task to prevent duplicate pickup
- ✅ **Update status frequently:** Give observers visibility into progress
- ✅ **Link to commits/PRs:** Make work traceable
- ✅ **Verify acceptance criteria before review:** Don't hand off incomplete work
- ✅ **Block vs. abandon:** If stuck, mark blocked with clear explanation

### Monitoring

- ✅ **Check heartbeat activity:** Regular pulses = healthy agents
- ✅ **Track task velocity:** How long do tasks stay in each lane?
- ✅ **Review blockers:** Address stuck tasks quickly
- ✅ **Audit agent workload:** Distribute priority tasks evenly

## Related Documentation

- `docs/AGENT_SETUP.md` — Agent configuration and IDs
- `docs/API.md` — Full API reference (endpoints, auth, rate limits)
- `docs/DEPLOYMENT.md` — Multi-instance deployment with task sync
- `docs/TROUBLESHOOTING.md` — Common issues and solutions

---

**Last Updated:** 2026-02-14 | **Author:** Blueprint (Architect)
